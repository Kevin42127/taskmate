<Window xmlns="https://github.com/avaloniaui"
       xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
       xmlns:vm="using:TaskMateApp.ViewModels"
       xmlns:models="using:TaskMateApp.Models"
       xmlns:utils="using:TaskMateApp.Utils"
       x:Class="TaskMateApp.Views.MainWindow"
       x:DataType="vm:MainWindowViewModel"
       Title="TaskMate"
       Width="1200" Height="800"
       WindowStartupLocation="CenterScreen"
       Background="{DynamicResource BackgroundColor}"
       Icon="avares://TaskMateApp/Assets/app.ico">
    
    <Window.Resources>
        <utils:BoolToOpacityConverter x:Key="BoolToOpacityConverter"/>
        <utils:DateTimeToStringConverter x:Key="DateTimeToStringConverter"/>
        <utils:CompletedBackgroundConverter x:Key="CompletedBackgroundConverter"/>
        <utils:CompletedButtonConverter x:Key="CompletedButtonConverter"/>
        <utils:StringToOpacityConverter x:Key="StringToOpacityConverter"/>
        <utils:BorderColorConverter x:Key="BorderColorConverter"/>
        <utils:CompletedBorderColorConverter x:Key="CompletedBorderColorConverter"/>
        <utils:PriorityConverter x:Key="PriorityConverter"/>
        <utils:PriorityColorConverter x:Key="PriorityColorConverter"/>
    </Window.Resources>

    <Grid RowDefinitions="Auto,Auto,*" Background="Transparent" PointerPressed="MainGrid_PointerPressed" Focusable="True">
        <Border Grid.Row="0" 
                Background="{DynamicResource PrimaryColor}" 
                Padding="24,20">
            <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto">
                <TextBlock Grid.Column="0"
                           Text="TaskMate - 任務夥伴" 
                           FontSize="24" 
                           FontWeight="Bold" 
                           Foreground="White"
                           VerticalAlignment="Center"/>
                <Button Grid.Column="1"
                        Command="{Binding CompleteAllCommand}"
                        Background="#4CAF50"
                        Foreground="White"
                        FontSize="14"
                        FontWeight="SemiBold"
                        Padding="20,12"
                        Margin="0,0,8,0"
                        BorderThickness="0"
                        Cursor="Hand"
                        Content="一鍵完成"
                        RenderTransformOrigin="0.5,0.5">
                    <Button.RenderTransform>
                        <ScaleTransform ScaleX="1" ScaleY="1"/>
                    </Button.RenderTransform>
                    <Button.Transitions>
                        <Transitions>
                            <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.15"/>
                        </Transitions>
                    </Button.Transitions>
                    <Button.Styles>
                        <Style Selector="Button:pointerover">
                            <Setter Property="Background" Value="#388E3C"/>
                        </Style>
                        <Style Selector="Button:disabled">
                            <Setter Property="Background" Value="#BDBDBD"/>
                            <Setter Property="Foreground" Value="#757575"/>
                        </Style>
                        <Style Selector="Button:pressed">
                            <Setter Property="RenderTransform">
                                <ScaleTransform ScaleX="0.95" ScaleY="0.95"/>
                            </Setter>
                        </Style>
                    </Button.Styles>
                </Button>
                <Button Grid.Column="2"
                        Command="{Binding DeleteAllCommand}"
                        Background="#F44336"
                        Foreground="White"
                        FontSize="14"
                        FontWeight="SemiBold"
                        Padding="20,12"
                        Margin="0,0,8,0"
                        BorderThickness="0"
                        Cursor="Hand"
                        Content="一鍵刪除"
                        RenderTransformOrigin="0.5,0.5">
                    <Button.RenderTransform>
                        <ScaleTransform ScaleX="1" ScaleY="1"/>
                    </Button.RenderTransform>
                    <Button.Transitions>
                        <Transitions>
                            <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.15"/>
                        </Transitions>
                    </Button.Transitions>
                    <Button.Styles>
                        <Style Selector="Button:pointerover">
                            <Setter Property="Background" Value="#D32F2F"/>
                        </Style>
                        <Style Selector="Button:disabled">
                            <Setter Property="Background" Value="#BDBDBD"/>
                            <Setter Property="Foreground" Value="#757575"/>
                        </Style>
                        <Style Selector="Button:pressed">
                            <Setter Property="RenderTransform">
                                <ScaleTransform ScaleX="0.95" ScaleY="0.95"/>
                            </Setter>
                        </Style>
                    </Button.Styles>
                </Button>
                <Border Grid.Column="3"
                        Background="#FF9800"
                        CornerRadius="8"
                        Padding="24,12"
                        Cursor="Hand"
                        PointerPressed="AddTaskButton_PointerPressed"
                        RenderTransformOrigin="0.5,0.5">
                    <Border.RenderTransform>
                        <ScaleTransform ScaleX="1" ScaleY="1"/>
                    </Border.RenderTransform>
                    <Border.Transitions>
                        <Transitions>
                            <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.15"/>
                        </Transitions>
                    </Border.Transitions>
                    <Border.Styles>
                        <Style Selector="Border:pointerover">
                            <Setter Property="Background" Value="#F57C00"/>
                        </Style>
                        <Style Selector="Border:pressed">
                            <Setter Property="RenderTransform">
                                <ScaleTransform ScaleX="0.95" ScaleY="0.95"/>
                            </Setter>
                        </Style>
                    </Border.Styles>
                    <TextBlock Text="新增待辦"
                               Foreground="White"
                               FontSize="14"
                               FontWeight="SemiBold"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"/>
                </Border>
            </Grid>
        </Border>

        <Border Grid.Row="1"
                Background="{DynamicResource CardBackgroundColor}"
                BorderBrush="{DynamicResource BorderColor}"
                BorderThickness="0,0,0,1"
                Padding="24,16">
            <Grid ColumnDefinitions="*,Auto,Auto,Auto">
                <TextBox Grid.Column="0"
                         x:Name="SearchTextBox"
                         Text="{Binding SearchText, Mode=TwoWay}"
                         Watermark="搜尋任務..."
                         FontSize="14"
                         Padding="12,10"
                         BorderThickness="1"
                         BorderBrush="{DynamicResource InputBorderColor}"
                         Margin="0,0,16,0"
                         SelectionBrush="{DynamicResource PrimaryColor}"
                         SelectionForegroundBrush="White"
                         GotFocus="SearchTextBox_GotFocus"
                         TextInput="SearchTextBox_TextInput"
                         TextChanged="SearchTextBox_TextChanged">
                    <TextBox.Styles>
                        <Style Selector="TextBox:focus">
                            <Setter Property="BorderBrush" Value="{DynamicResource PrimaryColor}"/>
                            <Setter Property="BorderThickness" Value="2"/>
                        </Style>
                    </TextBox.Styles>
                </TextBox>
                <ComboBox Grid.Column="1"
                          SelectedItem="{Binding FilterStatus, Mode=TwoWay}"
                          FontSize="14"
                          Padding="12,10"
                          MinWidth="120"
                          Margin="0,0,8,0"
                          BorderThickness="1"
                          BorderBrush="{DynamicResource InputBorderColor}">
                    <ComboBox.Items>
                        <x:String>全部</x:String>
                        <x:String>未完成</x:String>
                        <x:String>已完成</x:String>
                    </ComboBox.Items>
                    <ComboBox.Styles>
                        <Style Selector="ComboBox:focus">
                            <Setter Property="BorderBrush" Value="{DynamicResource PrimaryColor}"/>
                            <Setter Property="BorderThickness" Value="2"/>
                        </Style>
                    </ComboBox.Styles>
                </ComboBox>
                <ComboBox Grid.Column="2"
                          SelectedItem="{Binding FilterPriority, Mode=TwoWay}"
                          FontSize="14"
                          Padding="12,10"
                          MinWidth="120"
                          Margin="0,0,8,0"
                          BorderThickness="1"
                          BorderBrush="{DynamicResource InputBorderColor}">
                    <ComboBox.Items>
                        <x:String>全部優先級</x:String>
                        <x:String>高</x:String>
                        <x:String>中</x:String>
                        <x:String>低</x:String>
                    </ComboBox.Items>
                    <ComboBox.Styles>
                        <Style Selector="ComboBox:focus">
                            <Setter Property="BorderBrush" Value="{DynamicResource PrimaryColor}"/>
                            <Setter Property="BorderThickness" Value="2"/>
                        </Style>
                    </ComboBox.Styles>
                </ComboBox>
            </Grid>
        </Border>

        <ScrollViewer Grid.Row="2" 
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled"
                      Margin="24">
            <ItemsControl ItemsSource="{Binding FilteredTasks}" x:Name="TasksItemsControl">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="models:TodoItem">
                        <Border Width="280"
                                MinHeight="200"
                                Margin="0,0,16,16"
                                Background="{Binding IsCompleted, Converter={StaticResource CompletedBackgroundConverter}}"
                                BorderThickness="1"
                                CornerRadius="8"
                                Padding="16"
                                Cursor="Hand"
                                RenderTransformOrigin="0.5,0.5"
                                Opacity="0"
                                AttachedToVisualTree="TaskCard_AttachedToVisualTree">
                            <Border.RenderTransform>
                                <ScaleTransform ScaleX="0.9" ScaleY="0.9"/>
                            </Border.RenderTransform>
                            <Border.Transitions>
                                <Transitions>
                                    <DoubleTransition Property="Opacity" Duration="0:0:0.3"/>
                                    <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.3"/>
                                    <BrushTransition Property="Background" Duration="0:0:0.3"/>
                                    <BrushTransition Property="BorderBrush" Duration="0:0:0.3"/>
                                </Transitions>
                            </Border.Transitions>
                            <Border.BorderBrush>
                                <MultiBinding Converter="{StaticResource CompletedBorderColorConverter}">
                                    <Binding Path="IsCompleted"/>
                                    <Binding Path="BorderColor"/>
                                </MultiBinding>
                            </Border.BorderBrush>
                            <Border.Styles>
                                <Style Selector="Border:pointerover">
                                    <Setter Property="RenderTransform">
                                        <ScaleTransform ScaleX="1.02" ScaleY="1.02"/>
                                    </Setter>
                                </Style>
                            </Border.Styles>
                            <Grid RowDefinitions="Auto,Auto,Auto,*,Auto">
                                <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                                    <TextBlock Grid.Column="0"
                                               Text="{Binding Title}"
                                               FontSize="16"
                                               FontWeight="Bold"
                                               Foreground="{DynamicResource TextPrimaryColor}"
                                               TextWrapping="Wrap"
                                               Margin="0,0,8,0"
                                               MaxHeight="48"
                                               TextTrimming="CharacterEllipsis"/>
                                    <Border Grid.Column="1"
                                            Background="{Binding Priority, Converter={StaticResource PriorityColorConverter}}"
                                            CornerRadius="4"
                                            Padding="8,4"
                                            VerticalAlignment="Top">
                                        <TextBlock Text="{Binding Priority, Converter={StaticResource PriorityConverter}}"
                                                   FontSize="11"
                                                   FontWeight="SemiBold"
                                                   Foreground="White"/>
                                    </Border>
                                </Grid>
                                <TextBlock Grid.Row="1"
                                           Text="{Binding Description}"
                                           FontSize="12"
                                           Foreground="{DynamicResource TextSecondaryColor}"
                                           TextWrapping="Wrap"
                                           Opacity="{Binding Description, Converter={StaticResource StringToOpacityConverter}}"
                                           Margin="0,0,0,8"
                                           MaxHeight="60"
                                           TextTrimming="CharacterEllipsis"/>
                                <TextBlock Grid.Row="2"
                                           Text="{Binding CreatedAt, Converter={StaticResource DateTimeToStringConverter}}"
                                           FontSize="11"
                                           Foreground="{DynamicResource TextSecondaryColor}"
                                           Margin="0,0,0,8"/>
                                <TextBlock Grid.Row="3"
                                           Text="{Binding CreatedAt, Converter={StaticResource DateTimeToStringConverter}}"
                                           FontSize="11"
                                           Foreground="{DynamicResource TextSecondaryColor}"
                                           VerticalAlignment="Bottom"
                                           Opacity="0"/>
                                <StackPanel Grid.Row="4" 
                                            Orientation="Horizontal" 
                                            HorizontalAlignment="Right"
                                            Margin="0,8,0,0">
                                    <Button Content="編輯"
                                            Click="EditButton_Click"
                                            Tag="{Binding}"
                                            Background="#9C27B0"
                                            Foreground="White"
                                            FontSize="12"
                                            FontWeight="SemiBold"
                                            Padding="16,8"
                                            Margin="0,0,8,0"
                                            BorderThickness="0"
                                            Cursor="Hand"
                                            RenderTransformOrigin="0.5,0.5">
                                        <Button.RenderTransform>
                                            <ScaleTransform ScaleX="1" ScaleY="1"/>
                                        </Button.RenderTransform>
                                        <Button.Transitions>
                                            <Transitions>
                                                <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.15"/>
                                            </Transitions>
                                        </Button.Transitions>
                                        <Button.Styles>
                                            <Style Selector="Button:pointerover">
                                                <Setter Property="Background" Value="#7B1FA2"/>
                                            </Style>
                                            <Style Selector="Button:pressed">
                                                <Setter Property="RenderTransform">
                                                    <ScaleTransform ScaleX="0.95" ScaleY="0.95"/>
                                                </Setter>
                                            </Style>
                                        </Button.Styles>
                                    </Button>
                                    <Button Content="完成"
                                            Click="ToggleCompleteButton_Click"
                                            Tag="{Binding}"
                                            Background="{Binding IsCompleted, Converter={StaticResource CompletedButtonConverter}}"
                                            Foreground="White"
                                            FontSize="12"
                                            FontWeight="SemiBold"
                                            Padding="16,8"
                                            Margin="0,0,8,0"
                                            BorderThickness="0"
                                            Cursor="Hand"
                                            RenderTransformOrigin="0.5,0.5">
                                        <Button.RenderTransform>
                                            <ScaleTransform ScaleX="1" ScaleY="1"/>
                                        </Button.RenderTransform>
                                        <Button.Transitions>
                                            <Transitions>
                                                <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.15"/>
                                            </Transitions>
                                        </Button.Transitions>
                                        <Button.Styles>
                                            <Style Selector="Button:pointerover">
                                                <Setter Property="Background" Value="#388E3C"/>
                                            </Style>
                                            <Style Selector="Button:disabled">
                                                <Setter Property="Foreground" Value="#FFFFFF"/>
                                                <Setter Property="Opacity" Value="0.6"/>
                                            </Style>
                                            <Style Selector="Button:pressed">
                                                <Setter Property="RenderTransform">
                                                    <ScaleTransform ScaleX="0.95" ScaleY="0.95"/>
                                                </Setter>
                                            </Style>
                                        </Button.Styles>
                                    </Button>
                                    <Button Content="刪除"
                                            Click="DeleteButton_Click"
                                            Tag="{Binding}"
                                            Background="{DynamicResource AccentRedColor}"
                                            Foreground="White"
                                            FontSize="12"
                                            Padding="16,8"
                                            BorderThickness="0"
                                            Cursor="Hand"
                                            RenderTransformOrigin="0.5,0.5">
                                        <Button.RenderTransform>
                                            <ScaleTransform ScaleX="1" ScaleY="1"/>
                                        </Button.RenderTransform>
                                        <Button.Transitions>
                                            <Transitions>
                                                <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.15"/>
                                            </Transitions>
                                        </Button.Transitions>
                                        <Button.Styles>
                                            <Style Selector="Button:pointerover">
                                                <Setter Property="Background" Value="#D32F2F"/>
                                            </Style>
                                            <Style Selector="Button:pressed">
                                                <Setter Property="RenderTransform">
                                                    <ScaleTransform ScaleX="0.95" ScaleY="0.95"/>
                                                </Setter>
                                            </Style>
                                        </Button.Styles>
                                    </Button>
                                </StackPanel>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
    </Grid>
</Window>
